# Crypto Specification

This document serves as a high level design document for the block cipher functions of dcrypt.

## Definitions
- `SALT` initialization vector generated with `random_bytes`.
- `COST` integer which will ultimately be passed as cost parameter to `PBKDF2`. Can be set to `0` in cases where a high entropy key is supplied for `PASSKEY`.
- `CIPHER` the chosen cipher method as a string
- `ALGO` the chosen hmac algorithm as a string
- `PASSKEY` a password or key selected
- `ENCRINFO` is the string `encryptionKey` + `|` + `CIPHER`
- `AUTHINFO` is the string `authenticationKey` + `|` + `CIPHER`
- `MTEXT` the plaintext message to be encrypted
- `PBKDF2` is the password-based key derivation function supported by PHP (hash_pbkdf2). The parameters are:
    - `ALGO`
    - `PASSKEY`
    - `SALT`
    - `COST` number of iterations
- `HKDF` is the password-based key derivation function supported by PHP (hash_hkdf) and defined as ([RFC-5869](https://tools.ietf.org/html/rfc5869)). The parameters are:
    - `ALGO`
    - derived key generated by `PBKDF2`
    - info string parameter
- `HMAC` is a HMAC checksum function supported by PHP (hash_hmac). The parameters are:
    - input data to hash
    - `ALGO`
    - `AKEY`

## Steps for encryption
1. Obtain a new `SALT` of appropriate size for given `CIPHER`
1. Derive a new key `PKEY` from `PASSKEY` using `PBKDF2()` when `COST >= 1`. If `COST = 0` (default) then `PKEY = PASSKEY`.
1. Derive authentication key `AKEY` = `HKDF` with info parameter = `AUTHINFO`
1. Derive encryption key `EKEY` = `HKDF` with info parameter = `ENCRINFO`
1. Use `OPENSSL_ENCRYPT` to get the raw encrypted string `CTEXT`
1. Generate a checksum where `CHECKSUM = HMAC(CTEXT)`
1. Concatenate the following values
    1. `SALT`
    1. `CHECKSUM`
    1. `TAG` (if required by `CIPHER`, otherwise skip)
    1. `CTEXT`
    
## Steps for decryption
1. Pop `SALT` off front of `CTEXT`
1. Same as step 2 from above
1. Same as step 3 from above
1. Save as step 4 from above
1. Pop `CHECKSUM` from front of `CTEXT`
1. Pop `TAG` from front of `CTEXT`
1. Generate a checksum where `COMPUTED = HMAC(CTEXT)`
1. If `COMPUTED != CHECKSUM` throw an exception
1. Use `OPENSSL_DECRYPT` to decrypt the raw data and return